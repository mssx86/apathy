From ef727aa3a7c1bd244cce22757d251e3078137f54 Mon Sep 17 00:00:00 2001
From: strupo <sheeit@users.noreply.github.com>
Date: Fri, 23 Oct 2020 00:18:29 +0100
Subject: [PATCH] Update lyrics_fetcher.cpp

Fix the Google lyrics fetcher, which many others use
---
 src/lyrics_fetcher.cpp | 25 ++++++++++++++++++++++---
 1 file changed, 22 insertions(+), 3 deletions(-)

diff --git a/src/lyrics_fetcher.cpp b/src/lyrics_fetcher.cpp
index 67f162b9..61ab565d 100644
--- a/src/lyrics_fetcher.cpp
+++ b/src/lyrics_fetcher.cpp
@@ -23,6 +23,7 @@
 
 #include <cstdlib>
 #include <cstring>
+#include <numeric>
 #include <boost/algorithm/string/join.hpp>
 #include <boost/algorithm/string/replace.hpp>
 #include <boost/algorithm/string/split.hpp>
@@ -247,11 +248,29 @@ LyricsFetcher::Result GoogleLyricsFetcher::fetch(const std::string &artist,
 		result.second = msgNotFound;
 		return result;
 	}
-	
+
 	data = unescapeHtmlUtf8(urls[0]);
-	
+
 	URL = data.c_str();
-	return LyricsFetcher::fetch("", "");
+
+	std::string data2;
+	CURLcode code2 = Curl::perform(data2, URL, google_url, true);
+
+	if (code2 != CURLE_OK) {
+		result.second = curl_easy_strerror(code2);
+		return result;
+	}
+
+	{
+		auto content = getContent(regex(), data2);
+		auto lyricsStr = std::accumulate(content.begin(), content.end(), std::string(""));
+		postProcess(lyricsStr);
+		result.first = true;
+		result.second = lyricsStr;
+	}
+
+	return result;
+
 }
 
 bool GoogleLyricsFetcher::isURLOk(const std::string &url)
