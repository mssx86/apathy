# 1
export   CFLAGS="-march=native -mtune=native -O3 -w"
export CXXFLAGS="$CFLAGS"

export       CC="clang"
export      CXX="clang++"
export       AR="llvm-ar"
export       LD="ld.bfd"
export       AS="llvm-as"
export       NM="llvm-nm"
export   RANLIB="llvm-ranlib"
export    STRIP="llvm-strip"
export  OBJCOPY="llvm-objcopy"
export  OBJDUMP="llvm-objdump"
export  OBJSIZE="llvm-size"
export  READELF="llvm-readelf"

# 2
tar xf /mss/work/sauces/llvm-10.0.1.src.tar.xz
cd llvm-10.0.1.src

tar xf /mss/work/sauces/clang-10.0.1.src.tar.xz -C tools
mv -v tools/clang-10.0.1.src/ tools/clang

tar xf /mss/work/sauces/lld-10.0.1.src.tar.xz   -C tools
mv -v tools/lld-10.0.1.src    tools/lld

# 3
mkdir -v build
cd       build

# 4
cmake \
 -DCMAKE_INSTALL_PREFIX=/opt/llvm-10.0.1    \
 -DCMAKE_BUILD_TYPE=Release                 \
 -DCMAKE_C_FLAGS_RELEASE_INIT="$CFLAGS"     \
 -DCMAKE_CXX_FLAGS_RELEASE_INIT="$CXXFLAGS" \
\
 -DLLVM_HOST_TRIPLE="$CHOST"            \
 -DLLVM_TARGETS_TO_BUILD="host"         \
 -DLLVM_DEFAULT_TARGET_TRIPLE="$CBUILD" \
\
 -DLLVM_BUILD_LLVM_DYLIB=ON  \
 -DLLVM_LINK_LLVM_DYLIB=ON   \
 -DLLVM_ENABLE_RTTI=ON       \
 -DLLVM_ENABLE_FFI=ON        \
 -DLLVM_ENABLE_EH=ON         \
\
 -DCLANG_LINK_CLANG_DYLIB=ON \
 -DCLANG_VENDOR=apathy       \
\
 -DLLVM_BUILD_EXAMPLES=OFF   \
 -DLLVM_BUILD_DOCS=OFF       \
 -DLLVM_BUILD_TESTS=OFF      \
 -DLLVM_INCLUDE_EXAMPLES=OFF \
 -DLLVM_ENABLE_SPHINX=OFF    \
 -DLLVM_ENABLE_DOXYGEN=OFF   \
 -DCLANG_BUILD_EXAMPLES=OFF  \
 -DCLANG_INCLUDE_DOCS=OFF    \
 -DCLANG_INCLUDE_TESTS=OFF   \
\
 -Wno-dev ..

# 5
/bin/busybox time make -j2

# 6
instdir="$PWD/KEK"
make DESTDIR="${instdir}" install

rm -rfv \
 "${instdir}"/opt/llvm-10.0.1/share/man \
 "${instdir}"/opt/llvm-10.0.1/share/clang/bash-autocomplete.sh

find "${instdir}"/opt/llvm-10.0.1/bin \
 -type f              -exec strip --strip-all      -v {} ';'

find "${instdir}"/opt/llvm-10.0.1/lib \
 -type f -name \*.a   -exec strip --strip-debug    -v {} ';'

find "${instdir}"/opt/llvm-10.0.1/lib \
 -type f -name \*.so* -exec strip --strip-unneeded -v {} ';'

# 7
doas -- cp -r  "${instdir}"/opt/llvm-10.0.1 /opt/
doas -- chown -R root:root /opt/llvm-10.0.1
