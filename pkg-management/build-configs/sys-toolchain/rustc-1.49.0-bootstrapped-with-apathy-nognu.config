# 1 >> extract the tarball
tar xf /mss/work/sauces/rustc-1.49.0-src.tar.xz
cd rustc-1.49.0-src/

# 2 >> bake in the apathy triples, apply llvm fixes.
pdir="/mss/repo/pkg-management/patches/rustc-1.49.0"
patch -p1 < "${pdir}"/0001-fix-could-not-canonicalize-error-in-destdir-inst.patch
patch -p1 < "${pdir}"/0002-fix-display-of-llvm-version-on-rustc-Vv.patch
patch -p1 < "${pdir}"/0003-use-libunwind-instead-of-libgcc_s.patch
patch -p1 < "${pdir}"/0004-add-x86_64-apathy-triples.patch

sed -i 's/crt_static_default = true/crt_static_default = false/' \
 ./compiler/rustc_target/src/spec/linux_musl_base.rs        \
 ./vendor/rustc-ap-rustc_target/src/spec/linux_musl_base.rs

# 3 >> gen the config
export        CC="clang"
export       CXX="clang++"
export        LD="$CC"
export        AR="llvm-ar"
export        AS="llvm-as"
export        NM="llvm-nm"
export     STRIP="llvm-strip"
export    RANLIB="llvm-ranlib"
export   OBJCOPY="llvm-objcopy"
export   OBJDUMP="llvm-objdump"
export   OBJSIZE="llvm-size"
export   READELF="llvm-readelf"

export    CFLAGS="-w -O2 -mtune=native -march=native"
export  CXXFLAGS="${CFLAGS}"
export   LDFLAGS="${CFLAGS} -Wl,--as-needed -Wl,--gc-sections -Wl,-O2 -Wl,--icf=all"
export RUSTFLAGS="-Clinker=$CC -Ctarget-cpu=native"

cp -rv "${pdir}"/config.toml .

# 4 >> build
export PKG_CONFIG_ALLOW_CROSS=1
time python3 ./x.py build -j 5

# 5 >> install
instdir="${PWD}"/KEK
DESTDIR="${instdir}" python3 ./x.py install

# 6 >> clean up
rm -rfv \
 "${instdir}"/etc                                                 \
 "${instdir}"/opt/rustc-1.49.0/lib/rustlib/components             \
 "${instdir}"/opt/rustc-1.49.0/lib/rustlib/etc                    \
 "${instdir}"/opt/rustc-1.49.0/lib/rustlib/install.log            \
 "${instdir}"/opt/rustc-1.49.0/lib/rustlib/manifest-*             \
 "${instdir}"/opt/rustc-1.49.0/lib/rustlib/rust-installer-version \
 "${instdir}"/opt/rustc-1.49.0/lib/rustlib/uninstall.sh           \
 "${instdir}"/opt/rustc-1.49.0/share

# 7 >> strip
strip --strip-all -v "${instdir}"/opt/rustc-1.49.0/bin/*

find "${instdir}"/opt/rustc-1.49.0/lib -name \*.so   \
 -exec strip --strip-unneeded -v {} ';'
find "${instdir}"/opt/rustc-1.49.0/lib -name \*.rlib \
 -exec strip --strip-debug    -v {} ';'
