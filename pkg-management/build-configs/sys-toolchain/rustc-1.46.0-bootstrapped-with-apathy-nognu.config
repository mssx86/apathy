# 1 >> extract the tarball
tar xf /mss/work/sauces/rustc-1.46.0-src.tar.xz
cd rustc-1.46.0-src/

# 2 >> patch for musl and libressl 3.2, also add apathy triples.
pdir="/mss/repo/pkg-management/patches/rustc-1.46.0"
patch -p1 < "${pdir}"/libressl-3.2.patch
patch -p1 < "${pdir}"/apathy-target.patch
patch -p1 < "${pdir}"/llvm-clang.patch

sed -i 's/crt_static_default = true/crt_static_default = false/' \
 src/librustc_target/spec/linux_musl_base.rs

# 3 >> remove checksums
for vendor in libc openssl-sys; do
 sed -i 's/\("files":{\)[^}]*/\1/' "vendor/$vendor/.cargo-checksum.json"
done

# 4 >> gen the config
export        CC="clang"
export       CXX="clang++"
export        LD="$CC"
export        AR="llvm-ar"
export        AS="llvm-as"
export        NM="llvm-nm"
export     STRIP="llvm-strip"
export    RANLIB="llvm-ranlib"
export   OBJCOPY="llvm-objcopy"
export   OBJDUMP="llvm-objdump"
export   OBJSIZE="llvm-size"
export   READELF="llvm-readelf"

export    CFLAGS="-w -O3 -mtune=native -march=native"
export  CXXFLAGS="${CFLAGS}"
export   LDFLAGS="${CFLAGS} -Wl,--as-needed -Wl,--gc-sections -Wl,-O2 -Wl,--icf=all"
export RUSTFLAGS="-Clinker=$CC"

cat > config.toml <<EOF
[llvm]
link-shared = true

[build]
build               = 'x86_64-apathy-linux-musl'
host                = ['x86_64-apathy-linux-musl']
target              = ['x86_64-apathy-linux-musl']

cargo               = '/opt/rustc-1.46.0/bin/cargo'
rustc               = '/opt/rustc-1.46.0/bin/rustc'
rustfmt             = '/opt/rustc-1.46.0/bin/rustfmt'
python              = 'python3'

extended            = true
tools               = ['cargo', 'rustfmt']

locked-deps         = true
vendor              = true
docs                = false
compiler-docs       = false
submodules          = false
sanitizers          = false
profiler            = false
full-bootstrap      = false

[install]
prefix              = '/opt/rustc-1.46.0'

[rust]
channel             = 'stable'
rpath               = false
codegen-units       = 1
debuginfo-level     = 0
debug               = false
backtrace           = false
jemalloc            = false
debug-assertions    = false
codegen-tests       = false

default-linker      = "clang"
lld                 = false
use-lld             = false
llvm-tools          = true
llvm-libunwind      = true

[target.x86_64-apathy-linux-musl]
llvm-config         = '/opt/llvm-11.0.0/bin/llvm-config'
crt-static          = false

cc                  = "clang"
cxx                 = "clang++"
ar                  = "llvm-ar"
linker              = "clang"
ranlib              = "llvm-ranlib"
EOF

# 5 >> build
export PKG_CONFIG_ALLOW_CROSS=1
/bin/busybox time python3 ./x.py build -j 4

# 6 >> install
# that x.py shit fails to do a destdir install if prefix is missing in the
# real system. state of the art build system everybody.
doas -- mkdir -pv "/opt/rustc-1.46.0"

instdir="${PWD}"/KEK
DESTDIR="${instdir}" python3 ./x.py install

# 7 >> clean up
rm -rfv \
 "${instdir}"/etc                              \
 "${instdir}"/opt/rustc-1.46.0/share           \
 "${instdir}"/opt/rustc-1.46.0/lib/rustlib/etc \
 "${instdir}"/opt/rustc-1.46.0/lib/rustlib/src \
 "${instdir}"/opt/rustc-1.46.0/lib/rustlib/x86_64-apathy-linux-musl/analysis

cd "${instdir}"/opt/rustc-1.46.0/lib/rustlib
rm -rfv \
 components   \
 install.log  \
 manifest-*   \
 uninstall.sh \
 rust-installer-version


# 8 >> strip
cd "${instdir}"/opt/rustc-1.46.0/bin
strip --strip-all -v *

cd "${instdir}"/opt/rustc-1.46.0/lib
find . -type f -name \*.so   -exec strip --strip-unneeded -v {} ';'
find . -type f -name \*.rlib -exec strip --strip-debug    -v {} ';'
