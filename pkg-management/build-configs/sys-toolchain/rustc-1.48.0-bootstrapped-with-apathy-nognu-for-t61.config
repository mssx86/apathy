# 1 >> extract the tarball
tar xf /mss/work/sauces/rustc-1.48.0-src.tar.xz
cd rustc-1.48.0-src/

# 2 >> patch for musl and libressl 3.2, also add apathy triples.
pdir="/mss/repo/pkg-management/patches/rustc-1.48.0"
patch -p1 < "${pdir}"/apathy-target.patch
patch -p1 < "${pdir}"/libressl-3.2.patch
patch -p1 < "${pdir}"/llvm-clang.patch

sed -i 's/crt_static_default = true/crt_static_default = false/' \
 ./compiler/rustc_target/src/spec/linux_musl_base.rs        \
 ./vendor/rustc-ap-rustc_target/src/spec/linux_musl_base.rs \

# 3 >> remove checksums
for vendor in libc openssl-sys rustc-ap-rustc_target; do
 sed -i 's/\("files":{\)[^}]*/\1/' "vendor/$vendor/.cargo-checksum.json"
done

# 4 >> gen the config
t61flags="-m64 -m80387 -mcx16 -mfancy-math-387 -mfxsr -mhard-float -mieee-fp"
t61flags="${t61flags} -mlong-double-80 -mmmx -mred-zone -msahf -msse -msse2 -msse3 -msse4.1"
t61flags="${t61flags} -mssse3 -mtls-direct-seg-refs -march=core2 -mtune=core2"

export        CC="clang"
export       CXX="clang++"
export        LD="$CC"
export        AR="llvm-ar"
export        AS="llvm-as"
export        NM="llvm-nm"
export     STRIP="llvm-strip"
export    RANLIB="llvm-ranlib"
export   OBJCOPY="llvm-objcopy"
export   OBJDUMP="llvm-objdump"
export   OBJSIZE="llvm-size"
export   READELF="llvm-readelf"

export    CFLAGS="-w -O3 ${t61flags}"
export  CXXFLAGS="${CFLAGS}"
export   LDFLAGS="${CFLAGS} -Wl,--as-needed -Wl,--gc-sections -Wl,-O2 -Wl,--icf=all"
export RUSTFLAGS="-Clinker=$CC"

cat > config.toml <<EOF
[llvm]
link-shared = true

[build]
build               = 'x86_64-apathy-linux-musl'
host                = ['x86_64-apathy-linux-musl']
target              = ['x86_64-apathy-linux-musl']

cargo               = '/opt/rustc-1.48.0/bin/cargo'
rustc               = '/opt/rustc-1.48.0/bin/rustc'
rustfmt             = '/opt/rustc-1.48.0/bin/rustfmt'
python              = 'python3'

extended            = true
tools               = ['cargo', 'rustfmt']

locked-deps         = true
vendor              = true
docs                = false
compiler-docs       = false
submodules          = false
sanitizers          = false
profiler            = false
full-bootstrap      = false
local-rebuild       = true

[install]
prefix              = '/opt/rustc-1.48.0'

[rust]
channel             = 'stable'
rpath               = false
codegen-units       = 1
debuginfo-level     = 0
debug               = false
backtrace           = false
jemalloc            = false
debug-assertions    = false
codegen-tests       = false

default-linker      = "clang"
lld                 = false
use-lld             = false
llvm-tools          = true
llvm-libunwind      = true

[target.x86_64-apathy-linux-musl]
llvm-config         = '/opt/llvm-11.0.0/bin/llvm-config'
crt-static          = false

cc                  = "clang"
cxx                 = "clang++"
ar                  = "llvm-ar"
linker              = "clang"
ranlib              = "llvm-ranlib"
EOF

# 5 >> build
export PKG_CONFIG_ALLOW_CROSS=1
/bin/busybox time python3 ./x.py build -j 4

# 6 >> install
instdir="${PWD}"/KEK
DESTDIR="${instdir}" python3 ./x.py install

# 7 >> clean up
rm -rfv \
 "${instdir}"/etc                                                 \
 "${instdir}"/opt/rustc-1.48.0/lib/rustlib/components             \
 "${instdir}"/opt/rustc-1.48.0/lib/rustlib/etc                    \
 "${instdir}"/opt/rustc-1.48.0/lib/rustlib/install.log            \
 "${instdir}"/opt/rustc-1.48.0/lib/rustlib/manifest-*             \
 "${instdir}"/opt/rustc-1.48.0/lib/rustlib/rust-installer-version \
 "${instdir}"/opt/rustc-1.48.0/lib/rustlib/uninstall.sh           \
 "${instdir}"/opt/rustc-1.48.0/share

# 8 >> strip
strip --strip-all -v "${instdir}"/opt/rustc-1.48.0/bin/*

find "${instdir}"/opt/rustc-1.48.0/lib -name \*.so   \
 -exec strip --strip-unneeded -v {} ';'
find "${instdir}"/opt/rustc-1.48.0/lib -name \*.rlib \
 -exec strip --strip-debug    -v {} ';'

# 9 >> pkgup it
cd "${instdir}"/opt
pkgup rustc-1.48.0 \
 t61-rustc-1.48.0-x86_64-apathy-linux-musl-llvm11-nognu

syncboi t61-rustc-1.48.0-x86_64-apathy-linux-musl-llvm11-nognu.tar.zst \
 -e "ssh -p 3131" mss@t61solitude:/mnt/mss/stuff/techy-bits/packaged-software/ 
