# > 1
export      CC="x86_64-apathy-linux-musl-gcc"
export     CXX="x86_64-apathy-linux-musl-g++"
export      LD="ld.bfd"
export      AR="x86_64-apathy-linux-musl-gcc-ar"
export      AS="as"
export      NM="x86_64-apathy-linux-musl-gcc-nm"
export   STRIP="strip"
export  RANLIB="x86_64-apathy-linux-musl-gcc-ranlib"
export OBJCOPY="objcopy"
export OBJDUMP="objdump"
export OBJSIZE="size"
export READELF="readelf"

penis="/mss/work/table/KEK"

export            PATH="$penis/bin:$PATH"
export PKG_CONFIG_PATH="$penis/lib/pkgconfig:$PKG_CONFIG_PATH"
export LD_LIBRARY_PATH="$penis:$LD_LIBRARY_PATH"
export    LIBRARY_PATH="$LD_LIBRARY_PATH"

         CFLAGS="-fPIC -w -pipe -O3 -mtune=native -march=native -fcommon -flto -fuse-linker-plugin -fno-fat-lto-objects"
export   CFLAGS="${CFLAGS} -I$penis/include -L$penis/lib"
export CXXFLAGS="${CFLAGS}"
export  LDFLAGS="${CFLAGS} -Wl,--as-needed,--sort-common,-z,relro,-z,now,--gc-sections,-O2,-rpath=/opt/ioquake3/lib,--enable-new-dtags"

# > 2
tar xf /mss/work/sauces/SDL2-2.0.14.tar.gz
cd SDL2-2.0.14/

./configure \
 --build=$CBUILD              \
 --host=$CHOST                \
 --prefix=/mss/work/table/KEK \
 --disable-static             \
 --enable-shared

make
make install
cd .. && rm -rf SDL2-2.0.14/

# > 3
gcd1 --recursive https://github.com/ioquake/ioq3
cd ioq3

/mss/work/sauces/linuxq3apoint-1.32b-3.x86.run --tar xf

mymake(){
 make \
  ARCH="x86_64"                   \
  V=1                             \
 \
  BUILD_CLIENT=1                  \
  BUILD_SERVER=0                  \
  BUILD_BASEGAME=0                \
  BUILD_MISSIONPACK=0             \
  BUILD_GAME_QVM=0                \
  BUILD_GAME_SO=0                 \
  BUILD_RENDERER_OPENGL2=1        \
 \
  DEFAULT_BASEDIR="/opt/ioquake3" \
  FULLBINEXT=""                   \
  GENERATE_DEPENDENCIES=0         \
  OPTIMIZE=""                     \
  PLATFORM="linux"                \
  TOOLS_CC="${CC}"                \
  USE_CODEC_VORBIS=1              \
  USE_CODEC_OPUS=1                \
  USE_FREETYPE=1                  \
  USE_CURL=1                      \
  USE_CURL_DLOPEN=0               \
  USE_INTERNAL_JPEG=0             \
  USE_INTERNAL_SPEEX=1            \
  USE_INTERNAL_ZLIB=0             \
  USE_LOCAL_HEADERS=0             \
  USE_MUMBLE=0                    \
  USE_OPENAL=0                    \
  USE_OPENAL_DLOPEN=0             \
  USE_VOIP=1                      \
\
 ${@}
}

mymake

instdir="${PWD}/KEK"
mkdir -pv ${instdir}/opt/ioquake3/{baseq3,missionpack,demoq3,lib}

mymake COPYDIR="${instdir}/opt/ioquake3" copyfiles

cp -rfv ./baseq3/*.pk3                       "${instdir}/opt/ioquake3/baseq3/"
cp -rfv ./missionpack/*.pk3                  "${instdir}/opt/ioquake3/missionpack/"
ln -sfv /opt/ioquake3/baseq3/pak{1..8}.pk3   "${instdir}/opt/ioquake3/demoq3/"

cp -rfv "${penis}"/lib/libSDL2-2.0.so.0.14.0 "${instdir}/opt/ioquake3/lib/libSDL2-2.0.so.0"

strip --strip-all      -v "${instdir}"/opt/ioquake3/ioquake3
strip --strip-unneeded -v \
 "${instdir}"/opt/ioquake3/renderer_opengl2_x86_64.so \
 "${instdir}"/opt/ioquake3/renderer_opengl1_x86_64.so \
 "${instdir}"/opt/ioquake3/lib/libSDL2-2.0.so.0
