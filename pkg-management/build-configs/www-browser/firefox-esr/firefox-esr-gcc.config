# 1 >> extraction
tar xf /mss/work/sauces/firefox-78.6.0esr.source.tar.xz
cd     firefox-78.6.0/

# 2 >> build vars
export                 TMPDIR="/mss/work/thinltocache"

unset \
 CC CXX LD AR AS NM STRIP RANLIB OBJCOPY OBJDUMP \
 OBJSIZE READELF ADDR2LINE CFLAGS CXXFLAGS LDFLAGS

export                     CC="x86_64-apathy-linux-musl-gcc"
export                    CXX="x86_64-apathy-linux-musl-g++"
export                     AR="x86_64-apathy-linux-musl-gcc-ar"
export                     NM="x86_64-apathy-linux-musl-gcc-nm"
export                 RANLIB="x86_64-apathy-linux-musl-gcc-ranlib"

                       CFLAGS="-w -O3 -march=native -mtune=native -fstack-protector-strong -fcommon"
#                      CFLAGS="${CFLAGS} -flto=4 -fuse-linker-plugin -fno-fat-lto-objects"
                       CFLAGS="${CFLAGS} -fno-semantic-interposition -fdevirtualize-at-ltrans"
                       CFLAGS="${CFLAGS} -fgraphite-identity -floop-nest-optimize -ftree-vectorize"
export                 CFLAGS="${CFLAGS} -fno-math-errno -fno-trapping-math -fno-tree-loop-vectorize"
export               CXXFLAGS="${CFLAGS}"
                      LDFLAGS="${CFLAGS} -Wl,-rpath=/usr/lib/firefox "
export                LDFLAGS="${LDFLAGS} -Wl,-z,relro -Wl,-z,now -Wl,--as-needed -Wl,--gc-sections -Wl,-O2"

export              RUSTFLAGS="-Cdebuginfo=0 -Ctarget-cpu=native"
export            RUST_TARGET="x86_64-apathy-linux-musl"

export             MOZ_NOSPAM=1
export        MOZ_DEBUG_FLAGS="-g0"
export MACH_USE_SYSTEM_PYTHON=1

# 3 >> script vars
 repodir="/mss/repo/pkg-management/build-configs/www-browser/firefox-esr"
filesdir="${repodir}/files"
    pdir="${repodir}/patches"

# 4 >> apply patches
for file in "${pdir}"/*.patch; do patch -p1 < "${file}"; done

# 5 >> nuke addons and pocket
rm -rfv \
 browser/extensions/webcompat         \
 browser/extensions/doh-rollout       \ 
 browser/extensions/screenshots       \
 browser/extensions/report-site-issue \
 browser/components/pocket

# 6 >> add header from alpine
cp -vf "${filesdir}"/stab.h            toolkit/crashreporter/google-breakpad/src/

# 7 >> clear the default bookmarks
cp -vf "${filesdir}"/bookmarks.html.in browser/locales/generic/profile/bookmarks.html.in

# 8 >> clear sums
for sum in audio_thread_priority target-lexicon-0.9.0 proc-macro2 syn packed_simd; do
 sed -i 's/\("files":{\)[^}]*/\1/' third_party/rust/${sum}/.cargo-checksum.json
done

# 9 >> remove prebuilt binaries
find ./third_party -type f \( -name '*.so' -o -name '*.o' \) -print -delete

# 10 >> start the build
cp -v "${filesdir}"/mozconfig-gcc ./mozconfig
./mach build

# 11 >> install
instdir="$PWD/KEK"
DESTDIR="${instdir}" ./mach install

# 12 >> install prefs
install -v -Dm644 "${filesdir}"/vendor.js     \
 "${instdir}"/usr/lib/firefox/browser/defaults/preferences/vendor.js
install -v -Dm644 "${filesdir}"/policies.json \
 "${instdir}"/usr/lib/firefox/distribution/policies.json
