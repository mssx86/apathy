From 8f6157c0e49765f0dd8aedb032c2d7d270e7d6e6 Mon Sep 17 00:00:00 2001
From: Thomas Deutschmann <whissi@gentoo.org>
Date: Tue, 14 Jul 2020 15:57:10 +0200
Subject: [PATCH 30/38] bmo#1651207: Build the ICU data through an assembly
 file

Signed-off-by: Thomas Deutschmann <whissi@gentoo.org>
---
 config/external/icu/data/icu_data.S | 24 ++++++++++++++++++++++++
 config/external/icu/data/icudata.c  | 28 ----------------------------
 config/external/icu/data/moz.build  | 26 +++++++++-----------------
 3 files changed, 33 insertions(+), 45 deletions(-)
 create mode 100644 config/external/icu/data/icu_data.S
 delete mode 100644 config/external/icu/data/icudata.c

diff --git a/config/external/icu/data/icu_data.S b/config/external/icu/data/icu_data.S
new file mode 100644
index 0000000000..95e2e359f9
--- /dev/null
+++ b/config/external/icu/data/icu_data.S
@@ -0,0 +1,24 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#if defined(_WIN32) && defined(__i386__)
+// Mark the object as SAFESEH-enabled.
+.def @feat.00;
+.scl 3;
+.type 0;
+.endef
+.global @feat.00
+.set @feat.00, 1
+#endif
+
+.global ICU_DATA_SYMBOL
+#ifdef __APPLE__
+.data
+.const
+#else
+.section .rodata
+#endif
+.balign 16
+ICU_DATA_SYMBOL:
+    .incbin ICU_DATA_FILE
diff --git a/config/external/icu/data/icudata.c b/config/external/icu/data/icudata.c
deleted file mode 100644
index 7299ac9f6b..0000000000
--- a/config/external/icu/data/icudata.c
+++ /dev/null
@@ -1,28 +0,0 @@
-/* This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this
- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
-
-#ifdef __APPLE__
-#  define RODATA ".data\n.const"
-#else
-#  define RODATA ".section .rodata"
-#endif
-
-#if defined(__APPLE__) || (defined(_WIN32) && defined(__i386__))
-#  define _PREFIXED(x) _##x
-#else
-#  define _PREFIXED(x) x
-#endif
-#define PREFIXED(x) _PREFIXED(x)
-
-#define DATA(sym, file) DATA2(sym, file)
-// clang-format off
-#define DATA2(sym, file)              \
-  __asm__(".global " #sym "\n"        \
-          RODATA "\n"                 \
-          ".balign 16\n"              \
-          #sym ":\n"                  \
-          "    .incbin " #file "\n")
-// clang-format on
-
-DATA(PREFIXED(ICU_DATA_SYMBOL), ICU_DATA_FILE);
diff --git a/config/external/icu/data/moz.build b/config/external/icu/data/moz.build
index 84a8a9941e..26ae97a856 100644
--- a/config/external/icu/data/moz.build
+++ b/config/external/icu/data/moz.build
@@ -10,23 +10,15 @@ Library('icudata')
 
 LOCAL_INCLUDES += ['.']
 
-data_file = {
-    'little': 'icudt%sl.dat' % CONFIG['MOZ_ICU_VERSION'],
-    'big': 'icudt%sb.dat' % CONFIG['MOZ_ICU_VERSION'],
-}
-DEFINES['ICU_DATA_FILE'] = '"%s"' % data_file[CONFIG['TARGET_ENDIANNESS']]
-DEFINES['ICU_DATA_SYMBOL'] = 'icudt%s_dat' % CONFIG['MOZ_ICU_VERSION']
+prefix = ''
+if (CONFIG['OS_ARCH'] == 'WINNT' and CONFIG['CPU_ARCH'] == 'x86') or CONFIG['OS_ARCH'] == 'Darwin':
+    prefix = '_'
+
+DEFINES['ICU_DATA_FILE'] = '"%s/icudt%sl.dat"' % (SRCDIR, CONFIG['MOZ_ICU_VERSION'])
+DEFINES['ICU_DATA_SYMBOL'] = '%sicudt%s_dat' % (prefix, CONFIG['MOZ_ICU_VERSION'])
 SOURCES += [
-    'icudata.c',
+    'icu_data.S',
 ]
 
-if CONFIG['TARGET_ENDIANNESS'] == 'big':
-    HostLibrary('host_icudata')
-    HOST_DEFINES['ICU_DATA_FILE'] = '"%s"' % data_file['little']
-    HOST_DEFINES['ICU_DATA_SYMBOL'] = DEFINES['ICU_DATA_SYMBOL']
-    HOST_SOURCES += [
-        'icudata.c',
-    ]
-    GeneratedFile(data_file['big'],
-                  script='convert_icudata.py',
-                  inputs=[data_file['little']])
+if CONFIG['OS_ARCH'] == 'WINNT' and CONFIG['CC_TYPE'] == 'clang-cl':
+    USE_INTEGRATED_CLANGCL_AS = True
-- 
2.28.0

