# 1.0 >> install and export ondemands
pkgswdir="/mnt/mss/stuff/techy-bits/packaged-software"

pushd /opt
doas -- tar xfp "${pkgswdir}"/node.js-13.9.0.tar
doas -- tar xfp "${pkgswdir}"/rustc-1.43.1.tar.zst
doas -- tar xfp "${pkgswdir}"/llvm-clang-10.0.0.tar
doas -- tar xfp "${pkgswdir}"/cbindgen-0.14.2.tar.zst
popd

export            PATH="/opt/llvm-10.0.0/bin:$PATH"
export            PATH="/opt/rustc-1.43.1/bin:$PATH"
export            PATH="/opt/cbindgen-0.14.2/bin:$PATH"
export            PATH="/opt/node.js-13.9.0/bin:$PATH"
export    LIBRARY_PATH="/opt/llvm-10.0.0/lib:/opt/rustc-1.43.1/lib"
export LD_LIBRARY_PATH="${LIBRARY_PATH}"

# 1.1 >> set build vars
export              CC="/usr/bin/${CHOST}-gcc"
export             CXX="/usr/bin/${CHOST}-g++"

export          CFLAGS="-march=native -mtune=native -O2 -w"
export         LDFLAGS=" -Wl,-rpath=/usr/lib/firefox"
export        CXXFLAGS="${CFLAGS}"
export       RUSTFLAGS="-Cdebuginfo=0"

export      MOZ_NOSPAM=1
export  MOZ_LINK_FLAGS="${LDFLAGS}"
export MOZ_DEBUG_FLAGS="-g0"

# 1.2 >> set directories
 repodir="/mss/repo/pkg-management/build-configs/www-browser/firefox-esr"
filesdir="${repodir}/files"
    pdir="${repodir}/patches"


# 2.0 >> apply musl fixes and remove extensions
patch -p1 < "${pdir}"/0001-fix-bug-1261392.patch
patch -p1 < "${pdir}"/0002-fix-fortify-system-wrappers.patch
patch -p1 < "${pdir}"/0003-fix-seccomp-bpf.patch
patch -p1 < "${pdir}"/0004-fix-toolkit.patch
patch -p1 < "${pdir}"/0005-fix-tools.patch
patch -p1 < "${pdir}"/0006-fix-webrtc-glibcisms.patch
patch -p1 < "${pdir}"/0007-mallinfo.patch
patch -p1 < "${pdir}"/0008-remove-pocket.patch
patch -p1 < "${pdir}"/0009-remove-unwanted-extensions.patch

# 2.1 >> remove fxmonitor, screenshots, webcompat and pocket
rm -rfv \
 browser/extensions/fxmonitor          \
 browser/extensions/report-site-issue  \
 browser/extensions/screenshots        \
 browser/extensions/webcompat          \
\
 browser/components/pocket

# 2.2 >> add header from alpine
cp -vf "${filesdir}"/stab.h            \
 toolkit/crashreporter/google-breakpad/src/

# 2.3 >> clear the default bookmarks
cp -vf "${filesdir}"/bookmarks.html.in \
 browser/locales/generic/profile/bookmarks.html.in


# 3.0 >> copy the mozconfig
cp -v "${filesdir}"/mozconfig .

# 3.1 >> start the build
./mach build


# 4.0 >> install
instdir="$PWD/KEK"

DESTDIR="${instdir}" ./mach install
rm -rfv "${instdir}"/usr/lib/firefox/gtk2

# 4.1 >> install prefs
install -v -Dm644 "${filesdir}"/vendor.js     \
 "${instdir}"/usr/lib/firefox/browser/defaults/preferences/vendor.js
install -v -Dm644 "${filesdir}"/policies.json \
 "${instdir}"/usr/lib/firefox/distribution/policies.json

# 4.2 >> new tab override
install -v -Dm644 "${filesdir}"/apathy.cfg    \
 "${instdir}"/usr/lib/firefox/apathy.cfg
install -v -Dm644 "${filesdir}"/autoconfig.js \
 "${instdir}"/usr/lib/firefox/defaults/pref/autoconfig.js
