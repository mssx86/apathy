tar xf PM.tar.gz

export srcdir=/mss/work/UXP
export repo=/mnt/mss/stuff/techy-bits/git-repositories/apathy/pkg-management/build-configs/www-browser/apathy-browser
export MOZBUILD_STATE_PATH="$srcdir/mozbuild"
export MOZCONFIG="$srcdir/mozconfig"
export CPPFLAGS="-pipe -O2 -Wno-format-overflow"
export CFLAGS="${CPPFLAGS}"
export CXXFLAGS="${CPPFLAGS}"
export _pmappdir=/usr/lib/apathy-browser-28.7.1
export LDFLAGS=" -Wl,-rpath,${_pmappdir}"

mv UXP-PM28.7.1_Release/ $srcdir
cd $srcdir

patch -p1 < "${repo}"/0001-apathy-browser-branding-28.7.1.patch

sed -i 's#xlocale#locale#' "${srcdir}"/intl/icu/source/i18n/digitlst.cpp

grep -rl -- '-Werror=format' | xargs sed -i 's/error=format/no-&/'

patch -Np0 -i /mnt/mss/stuff/techy-bits/git-repositories/bmlfs/patches/0002-i686-fix.patch

python2.7 ./mach build

DESTDIR=$PWD/KEK ./mach install

rm -rfv $PWD/KEK/usr/include
rm -rfv $PWD/KEK/usr/lib/apathy-browser-devel-28.7.1
rm -rfv $PWD/KEK/usr/share
